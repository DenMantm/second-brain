# Docker Compose for Second Brain - All Services
version: '3.8'

services:
  # API Server (Node.js + TypeScript)
  server:
    build:
      context: ./apps/web-ui/packages/server
      dockerfile: Dockerfile
    container_name: second-brain-server
    ports:
      - "3030:3030"
    environment:
      - NODE_ENV=production
      - PORT=3030
      - HOST=0.0.0.0
      - LOG_LEVEL=info
      - CORS_ORIGIN=https://localhost:8443
      - TTS_SERVICE_URL=http://tts-service:3002
      - STT_SERVICE_URL=http://stt-service:3003
      - LLM_SERVICE_URL=http://host.docker.internal:1234/v1
    restart: unless-stopped
    networks:
      - second-brain-network
    depends_on:
      - tts-service
      - stt-service
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3030/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Web Client (React + Vite + Nginx)
  client:
    build:
      context: ./apps/web-ui/packages/client
      dockerfile: Dockerfile
    container_name: second-brain-client
    ports:
      - "8081:8080"   # HTTP (redirects to HTTPS)
      - "8443:8443"   # HTTPS
    restart: unless-stopped
    networks:
      - second-brain-network
    depends_on:
      - server
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # Text-to-Speech Service (CPU)
  tts-service:
    build:
      context: ./apps/tts-service
      dockerfile: Dockerfile
    container_name: second-brain-tts
    ports:
      - "3002:3002"
    volumes:
      # Mount models directory (read-only)
      - ./models/piper:/models/piper:ro
      # Mount source code for development (optional, comment out for production)
      - ./apps/tts-service/src:/app/src:ro
    environment:
      - ENVIRONMENT=development
      - MODEL_PATH=/models/piper/en_US-ryan-high.onnx
      - VOICE_CONFIG_PATH=/models/piper/en_US-ryan-high.onnx.json
      - LOG_LEVEL=info
      # Quality Settings (optimized for clarity and naturalness)
      - TTS_NOISE_SCALE=0.4
      - TTS_LENGTH_SCALE=1.0
      - TTS_SAMPLE_RATE=22050
      - ENABLE_AUDIO_ENHANCEMENT=true
    restart: unless-stopped
    networks:
      - second-brain-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Speech-to-Text Service (CPU)
  stt-service:
    build:
      context: ./apps/stt-service
      dockerfile: Dockerfile
    container_name: second-brain-stt
    ports:
      - "3003:3003"
    volumes:
      # Mount models directory for Whisper models
      - ./models/whisper:/models/whisper
      # Mount source code for development (optional, comment out for production)
      - ./apps/stt-service/src:/app/src:ro
    environment:
      - ENVIRONMENT=development
      - MODEL_PATH=/models/whisper
      - MODEL_SIZE=base
      - DEVICE=cpu
      - COMPUTE_TYPE=int8
      - LOG_LEVEL=info
    restart: unless-stopped
    networks:
      - second-brain-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  second-brain-network:
    driver: bridge

# Quick reference:
# Start all services:     docker-compose up -d
# Stop all services:      docker-compose down
# View logs:              docker-compose logs -f [service]
# Restart service:        docker-compose restart [service]
# 
# Services:
#   - client:       http://localhost:8080 (Web UI)
#   - server:       http://localhost:3030 (API)
#   - tts-service:  http://localhost:3002 (Text-to-Speech)
#   - stt-service:  http://localhost:3003 (Speech-to-Text)
